import React, { useContext, useState } from 'react'
import TextField from '@mui/material/TextField';
import  Button  from '@mui/material/Button';
import { IoMdEye } from "react-icons/io";
import { IoMdEyeOff } from "react-icons/io";
import { Link, useNavigate } from 'react-router-dom';
import { FcGoogle } from "react-icons/fc";
// C√°c H√†m S·ª≠ D·ª•ng v·ªõi Server
import CircularProgress from '@mui/material/CircularProgress';
import { MyContext } from '../../App';
import { postData } from '../../utils/api';

// C·ªßa ƒêK b·∫±ng T√†i Kho·∫£n Google
import { getAuth, signInWithPopup, GoogleAuthProvider } from "firebase/auth";
import { firebaseApp } from '../../firebase';
const auth = getAuth(firebaseApp);
const googleProvider = new GoogleAuthProvider();



const Login = () => {
     
    // ·∫®n hi·ªán m·∫≠t kh·∫©u
    const [ isPasswordShow, setIsPasswordShow] = useState(false)
    // Code k·∫øt n·ªëi server
    const [isLoading, setIsLoading] = useState(false);
    const [formFields, setFormFields ] = useState({
        email:'',
        password:''
    });

    const context = useContext(MyContext);
    const history = useNavigate();

        const onChangeInput = (e) => {
            const { name, value } = e.target;
                setFormFields(() => {
                    return {
                    ...formFields,
                    [name]: value
                }
        })
    }

       const valideValue = Object.values(formFields).every(el => el)
    
        // H√†m k·∫øt n·ªëi API data
            const handleSubmit = (e) => {
                e.preventDefault();

                

            if(formFields.email==="") {
                context.alertBox("error", "Vui l√≤ng nh·∫≠p id email");
                return false
                }
    
            if (formFields.password==="") {
            context.alertBox("error", "Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u c·ªßa b·∫°n");
            return false;
                }
    
          setIsLoading(true);
    
            postData("/api/user/login", formFields, { withCredentials: true }).then((res) => {
               console.log(res)

            if (res?.error !== true) {
                setIsLoading(false);
                context.alertBox("success", res?.message);
                setFormFields({
                    email: "",
                    password: ""
                })

                localStorage.setItem("accessToken", res?.data?.accessToken);
                localStorage.setItem("refreshToken", res?.data?.refreshToken);
                
                context.setIsLogin(true);

                history("/")
            } else {
                context.alertBox("error", res?.message);
                 setIsLoading(false);
            }   
        })
    }

    // Qu√™n m·∫≠t kh·∫©u
    const forgotPassword = () =>{
            if(formFields.email===""){
                    context.alertBox("error", "Vui l√≤ng nh·∫≠p id email");
                return false;
            }
            else {
                context.alertBox("success", `OTP send to ${formFields.email}`);
                localStorage.setItem("userEmail", formFields.email);
                localStorage.setItem("actionType", 'forgot-password');

                postData("/api/user/forgot-password", {
                    email: formFields.email,

                }).then((res) => {
            if (res?.error === false) {
                    context.alertBox("success", res?.message);
                        history("/verify")
            } else {
                    context.alertBox("error", res?.message);
                    }
                })
            }
    }

   
     // C·ªßa ƒêK t√†i kho·∫£n Google
    
        const authwithGoogle = () => {
    
            signInWithPopup(auth, googleProvider)
                .then((result) => {
    
                    const credential = GoogleAuthProvider.credentialFromResult(result);
                    const token = credential.accessToken;
                    // The signed-in user info.
                    const user = result.user;
    
                    // ph·∫ßn user.model
                    const fields = {
                        name: user.providerData[0].displayName,
                        email: user.providerData[0].email,
                        password: null,
                        avatar: user.providerData[0].photoURL,
                        mobile: user.providerData[0].phoneNumber,
                        role: "USER"
                    };
    
                    postData("/api/user/authWithGoogle", fields).then((res) => {
    
                        if (res?.error !== true) {
                            setIsLoading(false);
                            context.alertBox("success", res?.message);
                            localStorage.setItem("userEmail", fields.email)
    
                            localStorage.setItem("accessToken", res?.data?.accessToken);
                            localStorage.setItem("refreshToken", res?.data?.refreshToken);
    
                             // üî• C·∫≠p nh·∫≠t l·∫°i context.userData
                            context.setUserData(res?.data?.user);
    
                            context.setIsLogin(true);
    
                            history("/")
                        } else {
                            context.alertBox("error", res?.message);
                            setIsLoading(false);
                        }
                    })
    
                }).catch((error) => {
                    // Handle Errors here.
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    // The email of the user's account used.
                    const email = error.customData.email;
                    // The AuthCredential type that was used.
                    const credential = GoogleAuthProvider.credentialFromError(error);
                    // ...
                });
    
        }

  return (
    <section className='section py-10'>
            <div className='container'>
                <div className='card shadow-md w-[400px] m-auto rounded-md bg-white p-5 px-10 '>
                    <h3 className='text-center text-[18px] text-black'>ƒêƒÉng nh·∫≠p v√†o t√†i kho·∫£n c·ªßa b·∫°n</h3>
                <form className='w-full mt-5' onSubmit={handleSubmit}>
                    <div className='form-group w-full mb-5' >
                              <TextField name='email' 
                                        type='email' 
                                        id="email" 
                                        label="Email" 
                                        variant="outlined" className='w-full'
                                        onChange={onChangeInput} 
                                        value={formFields.email} 
                                        disabled={isLoading===true ? true : false}
                                        />
                    </div>

                    <div className='form-group w-full mb-5 relative'>
                              <TextField name='password'
                                        type={isPasswordShow === false ? 'password' : 'text'} 
                                        id="password" 
                                        label="M·∫≠t kh·∫©u *" 
                                        variant="outlined" className='w-full'
                                        onChange={onChangeInput} 
                                        value={formFields.password} 
                                        disabled={isLoading===true ? true : false}

                                        />
                        <Button  className='!absolute top-[10px] right-[10px] z-50 !w-[35px] !h-[35px] !min-w-[35px] !rounded-full !text-black'
                                onClick={()=>{setIsPasswordShow(!isPasswordShow)}}>
                                {
                                    isPasswordShow === false ? <IoMdEye className='text-[20px] opacity-75'/> :
                                                              <IoMdEyeOff className='text-[20px] opacity-75'/>
                                }
                        </Button>
                    </div>
                                <a className='link cursor-pointer text-[14px] font-[600]' onClick={forgotPassword}>Qu√™n m·∫≠t kh·∫©u?</a>
                           
                             <div className='flex items-center w-full mt-3 mb-3'>
                                    <Button type='submit' disabled={!valideValue}
                                            className='btn-org1 btn-lg w-full flex gap-3'>
                                            {
                                                isLoading === true ? <CircularProgress color="inherit" /> : 'ƒêƒÇNG NH·∫¨P'
                                            }
                                    </Button>
                            </div>

                            <p className='text-center'>Ch∆∞a c√≥ t√†i kho·∫£n? &nbsp; 
                                <Link className='link text-[14px] font-[600] text-primary ' to='/register'>ƒêƒÉng k√Ω</Link>
                            </p>

                            <p className='text-center font-[500]'>Ho·∫∑c ƒëƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n x√£ h·ªôi</p>

                            <Button className='flex gap-3 w-full !bg-[#f1f1f1] !text-black'
                                    onClick={authwithGoogle}>
                                <FcGoogle className='text-[20px]'/> ƒêƒÇNG NH·∫¨P V·ªöI GOOGLE
                            </Button>

                </form>
                </div>

            </div>      
    </section>
  )
}

export default Login;
